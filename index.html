// 全画像をプリロード（読み込み済み）状態にするための配列
let preloadedImages = [];

function startMegaLottery() {
    const ms = [], fs = [];
    for(let i=1;i<=8;i++){ const v=document.getElementById(`m${i}`).value; if(v) ms.push(v); }
    for(let i=1;i<=4;i++){ const v=document.getElementById(`f${i}`).value; if(v) fs.push(v); }
    if(ms.length < 1 || fs.length < 1) return alert("名前を入力してゾ");

    // --- 【修正ポイント1】全画像を事前に読み込ませてチラつきを防止 ---
    [...shuffleImageIds, ...finalImageIds].forEach(id => {
        const img = new Image();
        img.src = getDriveImg(id);
        preloadedImages.push(img);
    });

    const body = document.getElementById('body');
    const overlay = document.getElementById('overlay');
    const shuffleImg = document.getElementById('shuffle-img');
    const shuffleZone = document.getElementById('shuffle-zone');
    const countdownZone = document.getElementById('countdown-zone');
    const blackout = document.getElementById('blackout');
    const cutInImg = document.getElementById('cut-in-img');
    const star = document.getElementById('star');

    document.getElementById('results').style.display = 'none';
    body.classList.add('rumbling');
    overlay.style.display = 'flex';

    const allNames = [...ms, ...fs];
    
    // --- 【修正ポイント2】乱数の偏りを抑えるロジックに変更 ---
    let lastImgIndex = -1;
    const shuffleInterval = setInterval(() => {
        shuffleZone.textContent = allNames[Math.floor(Math.random() * allNames.length)];
        
        // 前回と同じ画像が連続で出にくいように制御
        let nextImgIndex;
        do {
            nextImgIndex = Math.floor(Math.random() * shuffleImageIds.length);
        } while (nextImgIndex === lastImgIndex);
        
        lastImgIndex = nextImgIndex;
        shuffleImg.src = getDriveImg(shuffleImageIds[nextImgIndex]);
    }, 60); // 速度が速すぎる場合はここを 80 くらいにすると安定します

    let count = 3;
    countdownZone.textContent = count;
    const countInterval = setInterval(() => {
        count--;
        if(count > 0) {
            countdownZone.textContent = count;
        } else {
            clearInterval(countInterval);
            clearInterval(shuffleInterval);
            
            body.classList.remove('rumbling');
            overlay.style.display = 'none';
            blackout.style.display = 'block';
            
            // 決め絵もランダムに選択
            const finalId = finalImageIds[Math.floor(Math.random() * finalImageIds.length)];
            cutInImg.src = getDriveImg(finalId);
            
            setTimeout(() => { 
                cutInImg.style.opacity = '1'; 
            }, 100);

            setTimeout(() => {
                cutInImg.style.opacity = '0';
                setTimeout(() => {
                    star.classList.add('anim-shoot');
                    setTimeout(() => {
                        blackout.style.display = 'none';
                        star.classList.remove('anim-shoot');
                        showResults(ms, fs);
                    }, 1200);
                }, 800);
            }, 2000);
        }
    }, 1000);
}
